# 확률 계산 방식

이 앱이 그래프·표를 계산하는 방법을 수식으로 표현합니다. (구현은 `src/lib/prob.ts`).

## 추출 확률 안내

### 기본 카테고리 확률

아나운서 포함 여부(`hasAnnouncer`)와 E.G.O 보유 상황(`egoAvailable`)에 따라:

**E.G.O가 뽑힐 수 있는 경우** (`egoAvailable = true`):

- 아나운서: 1.3% (포함 시), 0% (미포함 시)
- E.G.O: 1.3%
- 3성 인격: 2.9%
- 2성 인격: 12.8%
- 1성 인격: 81.7% (아나운서 포함), 83.0% (아나운서 미포함)

**모든 E.G.O를 보유한 경우** (`egoAvailable = false`):

- 아나운서: 1.3% (포함 시), 0% (미포함 시)
- E.G.O: 0%
- 3성 인격: 3.0%
- 2성 인격: 13.0%
- 1성 인격: 나머지 확률

### 특정 추출 반영

특정 추출에서 각 카테고리의 "원하는 대상" 확률은:

$$
\begin{aligned}
p_A^{\text{desired}} &= p_A^{\text{base}} \times 0.5 \times \frac{d_A}{f_A} \\
p_T^{\text{desired}} &= p_T^{\text{base}} \times 0.5 \times \frac{d_T}{f_T} \\
p_E^{\text{desired}} &= p_E^{\text{base}} \times h_E \times \frac{d_E}{f_E}
\end{aligned}
$$

여기서:

- $p_X^{\text{base}}$: 카테고리 X의 기본 확률
- $d_X, f_X$: 원하는 개수, 픽업 총 개수
- $h_E$: E.G.O 픽업 분배 비율
  - 1.0 (E.G.O 픽업이 있고 기존 E.G.O를 모두 보유한 경우)
  - 0.5 (그 외 경우)

### E.G.O 비복원 모델 (동적계획법)

E.G.O는 획득 시 풀에서 제거되는 특성을 2차원 상태 추적으로 모델링:

**상태 정의**: $(s, t)$ = 원하는 E.G.O $s$개, 전체 픽업 E.G.O $t$개 획득

**전이 확률** (매 뽑기):

- 원하는 E.G.O: $p_{\text{desired}} = p_{E,\text{base}} \times \frac{\text{남은 원하는}}{\text{남은 픽업}} \rightarrow (s+1, t+1)$
- 비원하는 E.G.O: $p_{\text{undesired}} = p_{E,\text{base}} \times \frac{\text{남은 비원하는}}{\text{남은 픽업}} \rightarrow (s, t+1)$
- 다른 카테고리: $p_{\text{other}} = 1 - p_{E,\text{base}} \rightarrow (s, t)$

**종료 조건**: $s \geq m_E$ (목표 달성) 상태에서 확률 질량 흡수

**성능 최적화**: 픽업 총 개수 > 12일 때 이항분포 근사로 폴백

### 10연 마지막 2성 확정

- 1~9번째: 기본 확률
- 10번째: `p2 += p1, p1 = 0` (2성 이상 확정)
- 본 플래너는 3성 인격만 취급하므로 실제 영향 없음

## 누적 달성 확률 $F(n)$

천장 교환 횟수를 $c_X$라 할 때, n번 뽑기에서 추가로 필요한 개수:
$$m_X = \max(0, d_X - c_X)$$

### 카테고리별 성공 확률

**아나운서(A)와 3성 인격(T)**: 이항분포 (복원 추출)
$$K_X \sim \text{Binomial}(n, p_X^{\text{desired}})$$
$$\Pr[K_X \geq m_X] = \sum_{k=m_X}^{n} \binom{n}{k} (p_X^{\text{desired}})^k (1-p_X^{\text{desired}})^{n-k}$$

**E.G.O(E)**: 상기 동적계획법 결과

### 전체 목표 달성 확률

카테고리 독립 가정:
$$F(n) = \Pr[K_A \geq m_A] \times \Pr[K_E \geq m_E] \times \Pr[K_T \geq m_T]$$

## 천장 교환 순서

### 천장 교환 순서 추천 ($\Delta F$ 기준)

각 천장 시점 $r \times 200$에서 실제 확률 증가량을 비교하여 선택:

1. 천장 직전: $n_{\text{before}} = 200r - 1$에서 $F_{\text{before}}$ 계산
2. 각 후보 카테고리 $c$에 대해 천장 직후: $n_{\text{after}} = 200r$에서 $F_{\text{after}}^{(c)}$ 계산
3. 확률 증가량: $\Delta F^{(c)} = F_{\text{after}}^{(c)} - F_{\text{before}}$
4. $\Delta F$가 최대인 카테고리 선택, 해당 카테고리가 불필요하면 E.G.O에 할당

### 사용자 지정 교환 우선순위

설정된 우선순위에 따라 필요한 첫 번째 카테고리에 할당:

- 기본 우선순위: E.G.O → 3성 인격 → 아나운서
- 모든 목표 달성 시 E.G.O에 할당

## 몬테카를로 시뮬레이션 보조선

분석적 모델의 직관적 확인을 위한 시뮬레이션 참조선:

**단일 뽑기 모델**:

- A/T 카테고리: 고정 확률로 선택 후 원하는/비원하는 베르누이 판정
- E.G.O: 고정 질량에서 남은 비율로 원하는/비원하는 판정 후 풀 갱신

**포인트 배치**: 0, 최대값, X축 눈금, 천장 경계(200r±1)에 포인트 생성  
**시각화**: 단조 보정 적용으로 누적 확률 성질 유지

## 1회 시뮬레이션(단일 경로)과 시각화

분석 모델과 별개로, 실제 뽑기 과정을 1회 경로로 재현하여 직관을 돕습니다. 구현은 `src/hooks/useSingleRunSim.ts`이며, 다음 규칙을 따릅니다.

### 진행 규칙

- 매 뽑기에서 카테고리 선택 확률은 기본 확률을 절반 분배한 값으로 사용합니다.
  - 아나운서: $p_A^{\text{pick}} = p_A^{\text{base}} \times 0.5$
  - E.G.O: $p_E^{\text{pick}} = p_E^{\text{base}} \times h_E$ (단, $h_E=1$ 혹은 $0.5$)
  - 3성 인격: $p_T^{\text{pick}} = p_T^{\text{base}} \times 0.5$
- 원하는 대상 당첨 판정
  - A/T: 픽업 내 원하는 비율 $\frac{d_X}{f_X}$로 베르누이 판정
  - E: 남은 픽업 수와 남은 원하는 수를 상태로 유지하며 $\frac{\text{남은 원하는}}{\text{남은 픽업}}$로 판정, 이후 풀을 1 감소시킴(비복원)
- 천장: $n$이 200의 배수가 되는 시점에 교환 1회 적용
  - 우선 사용자 지정 교환 계획을 따르고, 이미 불필요한 경우 설정된 우선순위(기본: E → T → A) 중 필요한 첫 항목으로 대체
- 종료: A/E/T의 남은 목표 수가 모두 0이 되는 즉시 시뮬레이션을 중단

### Luck 라인(남은 성공확률)

시뮬레이션 중 각 시점 $n$에서, 남은 뽑기 $N-n$로 목표를 달성할 확률을 분석식으로 계산해 표시합니다. 단, "향후 천장 효과"는 미리 반영하지 않습니다.

$$
\text{Luck}(n) = F_{\text{rem}}(N-n;\; m_A(n), m_E(n), m_T(n);\; \text{pity}=\varnothing)
$$

- $m_X(n)$: 시점 $n$에서 남은 목표 수
- $\text{pity}=\varnothing$: 남은 구간에 대해서는 천장 효과를 가정하지 않음

이 값은 0~1의 연속 값이며, 상태 변화에 따라 오르내리되, 실제 천장 적용 시점에 크게 상승합니다. 목표 달성 시 1로 스냅됩니다.

### 포인트 샘플링(라인 적재)

- 총 뽑기 $N$에 대해 $\max(1, \lfloor N/400 \rfloor)$ 간격으로 라인을 적재
- 천장 경계(200의 배수)에서는 즉시 적재하여 점프가 시각적으로 드러나도록 함
- 완료 시점이 샘플링 사이에 있더라도 마지막 포인트를 한 번 더 적재하여 경로를 보존

### 이벤트 점 표시

- 각 뽑기에서 실제로 원하는 A/E/T를 획득하거나, 천장 교환으로 감소한 경우 해당 시점의 Luck 높이에 점을 찍습니다.
- 점에 “아나운서/E.G.O/3성 인격 · 천장” 등 짧은 라벨을 표시하여 무슨 사건이었는지 구분합니다.

### 그래프 구성 요약

- 파란 실선: 분석 누적 확률 $F(n)$
- 보라 점선(선택): 몬테카를로 보조선(단조 보정)
- 주황 실선: Luck(n) — 남은 성공확률(향후 천장 미반영)
- 점 마커: 실제 획득/천장 이벤트
- 수직 점선: 보유 재화 기준선, 분위 지점, 천장 경계

## 분위수 및 표 계산

**분위수**: $F(n) \geq q$를 만족하는 최소 $n$을 이분탐색으로 계산

**Before/After 표**: 각 천장 회차 $r$에서 $F(200r-1)$과 $F(200r)$ 비교

## 재화 환산

보유 재화를 뽑기 횟수로 환산 (10연 우선):

$$
\begin{aligned}
n_{10}^{(\text{광기})} &= \left\lfloor \frac{L}{1300} \right\rfloor \\
L_{\text{잔여}} &= L \bmod 1300 \\
n_1^{(\text{광기})} &= \left\lfloor \frac{L_{\text{잔여}}}{130} \right\rfloor \\
N_{\text{총}} &= 10 \times (T_{10} + n_{10}^{(\text{광기})}) + (T_1 + n_1^{(\text{광기})})
\end{aligned}
$$

**자동 최대 범위**: $(d_A + d_E + d_T) \times 200$

## 모델의 가정과 한계

본 계산 모델은 다음과 같은 가정을 바탕으로 하므로 실제 결과와 차이가 있을 수 있습니다. 몬테카를로 기반 시뮬레이션으로 모델의 타당성을 보조합니다.

### 주요 가정

- **추출 방식**: 아나운서/인격은 복원, E.G.O는 비복원
- **카테고리 독립**: 실제로는 상호배타적이나 독립 곱으로 근사
- **최적 행동**: 추천 천장 교환 순서 준수, 목표 달성 시 뽑기 중단

### 오차 원인

- **독립 근사**: 카테고리 간 약한 음의 상관 무시 (주요 원인)
- **E.G.O 폴백**: E.G.O 픽업 12개 초과 시 계산 효율을 위해 이항분포 근사 사용.
- **동적 변화**: 뽑기 중 목표/전략 변경, 이벤트 보상 미반영

따라서 본 계산 결과는 **참고용 추정치**로 활용하시기 바랍니다.
